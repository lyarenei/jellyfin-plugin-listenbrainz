<!DOCTYPE html>
<html lang="en">
<head>
    <title>ListenBrainz Plugin Config</title>
</head>
<body>
<div id="ListenBrainzConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-controller="__plugin/ListenBrainz.js"
     data-require="emby-input,emby-button,emby-select,emby-checkbox">
    <div data-role="content">
        <div class="content-primary">
            <form id="ListenBrainzPluginConfigForm">
                <div class="sectionTitleContainer flex align-items-center">
                    <h2 class="sectionTitle">ListenBrainz Plugin Config</h2>
                    <a class="raised button-alt headerHelpButton emby-button" is="emby-linkbutton"
                       rel="noopener noreferrer" target="_blank"
                       href="https://github.com/lyarenei/jellyfin-plugin-listenbrainz#configuration">Documentation</a>
                </div>
                <fieldset class="verticalSection verticalSection-extrabottompadding">
                    <legend>
                        <h3>User Config</h3>
                    </legend>
                    <div class="bootstrap-wrapper container">
                        <div class="selectContainer bootstrap-wrapper row no-gutters">
                            <label class="selectLabel" for="JellyfinUser">Select Jellyfin user</label>
                            <select is="emby-select" id="JellyfinUser" name="JellyfinUser"></select>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="ListenBrainzApiToken">
                                ListenBrainz API token
                            </label>
                            <div class="bootstrap-wrapper row no-gutters">
                                <input id="ListenBrainzApiToken" name="ListenBrainzApiToken" type="password"
                                       is="emby-input" class="bootstrap-wrapper col-md-9 vertical-center"/>
                                <div id="CheckListenBrainzApiToken"
                                     class="raised button block emby-button bootstrap-wrapper col-md-2 offset-md-1 vertical-center">
                                    Check
                                </div>
                            </div>
                            <div class="fieldDescription">
                                User API token. Can be found in
                                <a class="inputLabel" target="_blank" href="https://listenbrainz.org/profile/">
                                    user profile</a>.
                            </div>
                        </div>
                        <div class="checkboxContainer bootstrap-wrapper row no-gutters">
                            <label class="inputLabel inputLabelUnfocused" for="IsListenSubmitEnabled">
                                <input is="emby-checkbox" type="checkbox" id="IsListenSubmitEnabled"
                                       name="IsListenSubmitEnabled"/>
                                <span>Enable submitting listens</span>
                            </label>
                        </div>
                        <div class="checkboxContainer bootstrap-wrapper row no-gutters">
                            <label class="inputLabel inputLabelUnfocused" for="IsFavoritesSyncEnabled">
                                <input is="emby-checkbox" type="checkbox" id="IsFavoritesSyncEnabled"
                                       name="IsFavoritesSyncEnabled"/>
                                <span>Enable syncing favorites</span>
                            </label>
                        </div>
                        <div class="checkboxContainer bootstrap-wrapper row no-gutters">
                            <label class="inputLabel inputLabelUnfocused" for="IsPlaylistsSyncEnabled">
                                <input is="emby-checkbox" type="checkbox" id="IsPlaylistsSyncEnabled"
                                       name="IsPlaylistsSyncEnabled"/>
                                <span>Enable syncing playlists</span>
                            </label>
                        </div>
                        <div class="checkboxContainer bootstrap-wrapper row no-gutters">
                            <label class="inputLabel inputLabelUnfocused" for="IsUserBackupEnabled">
                                <input is="emby-checkbox" type="checkbox" id="IsUserBackupEnabled"
                                       name="IsUserBackupEnabled"/>
                                <span>Enable listens backup</span>
                            </label>
                            <div class="fieldDescription">Has no effect if backup path is not configured.</div>
                        </div>
                        <div class="checkboxContainer bootstrap-wrapper row no-gutters">
                            <label class="inputLabel inputLabelUnfocused" for="IsStrictModeEnabled">
                                <input is="emby-checkbox" type="checkbox" id="IsStrictModeEnabled"
                                       name="IsStrictModeEnabled"/>
                                <span>Enable strict mode for listen submission.</span>
                            </label>
                            <div class="fieldDescription">Only submit listens when certain metadata are available. See plugin documentation for more details.</div>
                        </div>
                        <div class="bootstrap-wrapper row no-gutters horizontal-center">
                            <button is="emby-button" type="submit" id="SaveUserConfig"
                                    class="raised button-submit block emby-button col-md-2">
                                Save
                            </button>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="verticalSection">
                    <legend>
                        <h3>General Config</h3>
                    </legend>
                    <div class="bootstrap-wrapper container">
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="ListenBrainzApiUrl">
                                ListenBrainz API URL
                            </label>
                            <div class="bootstrap-wrapper row no-gutters">
                                <input id="ListenBrainzApiUrl" name="ListenBrainzApiUrl" type="text"
                                       is="emby-input" class="bootstrap-wrapper col-md-9 vertical-center"/>
                                <div id="ResetListenBrainzApiUrl"
                                     class="raised button block emby-button bootstrap-wrapper col-md-2 offset-md-1 vertical-center">
                                    Reset
                                </div>
                            </div>
                            <div class="fieldDescription">Set a custom ListenBrainz API URL.</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="MusicBrainzApiUrl">
                                MusicBrainz API URL
                            </label>
                            <div class="bootstrap-wrapper row no-gutters">
                                <input id="MusicBrainzApiUrl" name="MusicBrainzApiUrl" type="text"
                                       is="emby-input"
                                       class="bootstrap-wrapper col-md-9 vertical-center"/>
                                <div id="ResetMusicBrainzApiUrl"
                                     class="raised button block emby-button bootstrap-wrapper col-md-2 offset-md-1 vertical-center">
                                    Reset
                                </div>
                            </div>
                            <div class="fieldDescription">Set a custom MusicBrainz API URL. Requires restart to take effect.</div>
                        </div>
                        <div class="checkboxContainer">
                            <label class="inputLabel inputLabelUnfocused" for="IsMusicBrainzEnabled">
                                <input is="emby-checkbox" type="checkbox" id="IsMusicBrainzEnabled"
                                       name="IsMusicBrainzEnabled"/>
                                <span>Fetch additional metadata from MusicBrainz</span>
                            </label>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="IsAlternativeModeEnabled">
                                <input is="emby-checkbox" type="checkbox" id="IsAlternativeModeEnabled"
                                       name="IsAlternativeModeEnabled"/>
                                <span>Use alternative event for recognizing listens</span>
                            </label>
                            <div class="fieldDescription">Requires clients to mark items as played.</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="IsImmediateFavoriteSyncEnabled">
                                <input is="emby-checkbox" type="checkbox" id="IsImmediateFavoriteSyncEnabled"
                                       name="IsImmediateFavoriteSyncEnabled"/>
                                <span>Immediate favorite sync</span>
                            </label>
                            <div class="fieldDescription">Sync favorite status immediately.
                                Requires MusicBrainz metadata and integration to be enabled.
                            </div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="IsAllPlaylistsSyncEnabled">
                                <input is="emby-checkbox" type="checkbox" id="IsAllPlaylistsSyncEnabled"
                                       name="IsAllPlaylistsSyncEnabled"/>
                                <span>Sync all playlists from ListenBrainz</span>
                            </label>
                            <div class="fieldDescription">Sync all playlists from ListenBrainz, including
                                suggestion/recommendation playlists.
                            </div>
                        </div>
                        <div class="sectionTitleContainer flex align-items-center">
                            <h4 class="sectionTitle">Backup of listens</h4>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="BackupPath">Backup path</label>
                            <div class="bootstrap-wrapper row no-gutters">
                                <input id="BackupPath" name="BackupPath" type="text" is="emby-input"
                                       class="bootstrap-wrapper col-md-9 vertical-center"/>
                                <div id="SetBackupPath"
                                     class="raised button block emby-button bootstrap-wrapper col-md-2 offset-md-1 vertical-center">
                                    Browse
                                </div>
                            </div>
                        </div>
                        <div class="sectionTitleContainer flex align-items-center">
                            <h4 class="sectionTitle">Allowed libraries for listen submission</h4>
                            <div class="raised button-alt headerHelpButton emby-button" id="ResetAllowedLibraries">
                                Reset
                            </div>
                        </div>
                        <div class="inputContainer" id="LibrariesList"></div>
                        <div class="bootstrap-wrapper row no-gutters horizontal-center">
                            <button is="emby-button" type="submit" id="SaveGeneralConfig"
                                    class="raised button-submit block emby-button col-md-2">
                                Save
                            </button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
    <script type="text/javascript">
        // Cannot use let because of redeclaration.
        var ListenBrainzConfig = {
            PluginUniqueId: "59B20823-AAFE-454C-A393-17427F518631",
            UserDefaults: {
                JellyfinUserId: "",
                ApiToken: "",
                IsListenSubmitEnabled: false,
                IsFavoritesSyncEnabled: false,
                IsPlaylistsSyncEnabled: false,
                IsAllPlaylistsSyncEnabled: false,
                IsUserBackupEnabled: false,
                IsStrictModeEnabled: false,
            },
        };

        document.querySelector('#ListenBrainzConfigPage')
            .addEventListener('pageshow', () => {
                onPageShow();
            });

        document.querySelector('#JellyfinUser')
            .addEventListener('change', () => {
                onSelectUser()
            });

        document.querySelector('#CheckListenBrainzApiToken')
            .addEventListener('mouseup', () => {
                onCheckApiToken();
            });

        document.querySelector('#ResetListenBrainzApiUrl')
            .addEventListener('mouseup', () => {
                onResetListenBrainzApiUrl();
            });

        document.querySelector('#ResetMusicBrainzApiUrl')
            .addEventListener('mouseup', () => {
                onResetMusicBrainzApiUrl();
            });

        document.querySelector('#ResetAllowedLibraries')
            .addEventListener('mouseup', () => {
                onAllowedLibrariesReset();
            });

        document.querySelector('#ListenBrainzPluginConfigForm')
            .addEventListener('submit', (event) => {
                event.preventDefault();
                onSubmitConfigForm(event.submitter.id);
            });

        document.querySelector('#SetBackupPath')
            .addEventListener('mouseup', () => {
                onSetBackupPath();
            });

        function onPageShow() {
            loadCss('bootstrap-grid.min.css');
            loadCss('styles.css');

            Dashboard.showLoadingMsg();

            ApiClient.getUsers()
                .then((users) => {
                    buildUsersDropdown(users);
                    loadConfig(users[0].Id)
                })
                .catch((reason) => {
                    console.log("ListenBrainz plugin: Failed to load Jellyfin users: " + reason);
                    Dashboard.alert("Failed to load Jellyfin users");
                });

            Dashboard.hideLoadingMsg();
        }

        function onSelectUser() {
            Dashboard.showLoadingMsg();
            let userId = getSelectedUserId();
            ApiClient.getPluginConfiguration(ListenBrainzConfig.PluginUniqueId)
                .then((config) => {
                    let userConfig = getUserConfig(config, userId);
                    fillUserConfig(userConfig);
                })
                .catch((reason) => {
                    console.log("ListenBrainz plugin: Failed to load user config: " + reason);
                    Dashboard.alert("Failed to load user config");
                });

            Dashboard.hideLoadingMsg();
        }

        function onCheckApiToken() {
            let apiToken = getApiToken();
            if (!apiToken) {
                Dashboard.alert("No API token to verify");
                return;
            }

            ApiClient.ValidateListenBrainzToken(apiToken)
                .then((response) => {
                    if (response.IsValid) {
                        Dashboard.alert("Token is valid");
                        return;
                    }

                    Dashboard.alert("Token is not valid");
                    console.log("Token validation failed: " + response.Reason);
                })
                .catch((reason) => {
                    Dashboard.alert("Token validation failed");
                    console.log("Token validation failed: " + reason);
                });
        }

        function onSaveUserConfig() {
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(ListenBrainzConfig.PluginUniqueId)
                .then((config) => {
                    getUserConfigInputs()
                        .then((newUserConfig) => {
                            let index = config.UserConfigs.map((uc) => uc.JellyfinUserId).indexOf(newUserConfig.JellyfinUserId);
                            if (index < 0) {
                                config.UserConfigs.push(newUserConfig);
                            } else {
                                config.UserConfigs[index] = newUserConfig;
                            }

                            saveConfig(config);
                        })
                        .catch((err) => {
                            console.log("ListenBrainz plugin: Failed to get plugin config: " + err);
                            Dashboard.alert("Saving user config failed");
                        })
                })
                .catch((reason) => {
                    console.log("ListenBrainz plugin: Failed to get plugin config: " + reason);
                    Dashboard.alert("Saving user config failed");
                });

            Dashboard.hideLoadingMsg();
        }

        function onResetListenBrainzApiUrl() {
            ApiClient.getPluginConfiguration(ListenBrainzConfig.PluginUniqueId)
                .then((config) => {
                    document.querySelector('#ListenBrainzApiUrl').value = config.DefaultListenBrainzApiUrl;
                })
                .catch((reason) => {
                    console.log("ListenBrainz plugin: Failed to reset ListenBrainz URL: " + reason);
                    Dashboard.alert("Reset failed");
                });
        }

        function onResetMusicBrainzApiUrl() {
            ApiClient.getPluginConfiguration(ListenBrainzConfig.PluginUniqueId)
                .then((config) => {
                    document.querySelector('#MusicBrainzApiUrl').value = config.DefaultMusicBrainzApiUrl;
                })
                .catch((reason) => {
                    console.log("ListenBrainz plugin: Failed to reset MusicBrainz URL: " + reason);
                    Dashboard.alert("Reset failed");
                });
        }

        function onSetBackupPath() {
            const browser = new Dashboard.DirectoryBrowser();
            browser.show({
                includeFiles: false,
                callback: (selectedDir) => {
                    browser.close();
                    document.querySelector('#BackupPath').value = selectedDir;
                },
                header: "Select path for backups"
            })
        }

        function onSaveGeneralConfig() {
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(ListenBrainzConfig.PluginUniqueId)
                .then((config) => {
                    let newConfig = getGeneralConfigInputs();
                    newConfig.UserConfigs = config.UserConfigs;
                    saveConfig(newConfig);
                })
                .catch((reason) => {
                    console.log("ListenBrainz plugin: Failed to get plugin config: " + reason);
                    Dashboard.alert("Saving config failed");
                });

            Dashboard.hideLoadingMsg();
        }

        function onSubmitConfigForm(buttonId) {
            switch (buttonId) {
                case 'SaveGeneralConfig':
                    onSaveGeneralConfig();
                    break;
                case 'SaveUserConfig':
                    onSaveUserConfig();
                    break;
                default:
                    console.log("ListenBrainz plugin: invalid submitter ID");
                    Dashboard.alert("Something went wrong");
            }
        }

        async function onAllowedLibrariesReset() {
            const allLibraries = await ApiClient.GetAllLibraries();

            function isAllowed(libraryId) {
                const library = allLibraries.find(lib => lib.Id === libraryId);
                if (library) return library.LibraryType === 'music';
            }

            allLibraries.forEach((library) => {
                let checkbox = document.getElementById(library.Id);
                checkbox.checked = isAllowed(library.Id) ?? false;
            });
        }

        function loadCss(fileName) {
            let path = 'ListenBrainzPlugin/internal/styles/' + fileName;
            let exists = document.querySelector('style[data-lb-css="' + fileName + '"]');
            if (exists) return;

            ApiClient.ajax({
                type: "GET",
                url: ApiClient.getUrl(path),
            }).then((cssValue) => {
                let styleTag = document.createElement("style");
                styleTag.setAttribute('data-lb-css', fileName);
                styleTag.innerText = cssValue;
                document.getElementsByTagName("head")[0].appendChild(styleTag);
            });
        }

        function buildUsersDropdown(jellyfinUsers) {
            const dropdown = document.getElementById("JellyfinUser");
            dropdown.innerHTML = "";

            let html = "";
            jellyfinUsers.forEach((user) => {
                html += "<option value='" + user.Id + "'>" + user.Name + "</option>";
            })

            dropdown.innerHTML = html;
        }

        function fillGeneralConfig(data) {
            document.querySelector("#ListenBrainzApiUrl")
                .value = data.ListenBrainzApiUrl;

            document.querySelector("#MusicBrainzApiUrl")
                .value = data.MusicBrainzApiUrl;

            document.querySelector("#IsMusicBrainzEnabled")
                .checked = data.IsMusicBrainzEnabled;

            document.querySelector("#IsAlternativeModeEnabled")
                .checked = data.IsAlternativeModeEnabled;

            document.querySelector("#IsImmediateFavoriteSyncEnabled")
                .checked = data.IsImmediateFavoriteSyncEnabled;

            document.querySelector("#IsAllPlaylistsSyncEnabled")
                .checked = data.IsAllPlaylistsSyncEnabled;

            document.querySelector("#BackupPath")
                .value = data.BackupPath;

            try {
                buildAllowedLibrariesList(data.LibraryConfigs);
            } catch (err) {
                console.log("ListenBrainz plugin: Getting libraries from server failed: " + err);
                Dashboard.alert("Failed to load Jellyfin libraries");
            }
        }

        function getSelectedUserId() {
            return document.querySelector("#JellyfinUser").value;
        }

        function fillUserConfig(data) {
            document.querySelector("#ListenBrainzApiToken")
                .value = atob(data.ApiToken);

            document.querySelector("#IsListenSubmitEnabled")
                .checked = data.IsListenSubmitEnabled;

            document.querySelector("#IsFavoritesSyncEnabled")
                .checked = data.IsFavoritesSyncEnabled;

            document.querySelector("#IsPlaylistsSyncEnabled")
                .checked = data.IsPlaylistsSyncEnabled;

            document.querySelector("#IsUserBackupEnabled")
                .checked = data.IsBackupEnabled;

            document.querySelector("#IsStrictModeEnabled")
                .checked = data.IsStrictModeEnabled;
        }

        function getUserConfig(config, userId) {
            if (config.UserConfigs === null) {
                return ListenBrainzConfig.UserDefaults;
            }

            let index = config.UserConfigs.map((uc) => uc.JellyfinUserId).indexOf(userId);
            return index < 0 ? ListenBrainzConfig.UserDefaults : config.UserConfigs[index];
        }

        async function getUserConfigInputs() {
            const userName = await tryGetListenBrainzUserName(getApiToken());
            return {
                JellyfinUserId: getSelectedUserId(),
                ApiToken: btoa(getApiToken()),
                IsListenSubmitEnabled: document.querySelector('#IsListenSubmitEnabled').checked,
                IsFavoritesSyncEnabled: document.querySelector('#IsFavoritesSyncEnabled').checked,
                IsPlaylistsSyncEnabled: document.querySelector('#IsPlaylistsSyncEnabled').checked,
                IsBackupEnabled: document.querySelector('#IsUserBackupEnabled').checked,
                UserName: userName,
                IsStrictModeEnabled: document.querySelector('#IsStrictModeEnabled').checked,
            }
        }

        function getGeneralConfigInputs() {
            return {
                ListenBrainzApiUrl: document.querySelector('#ListenBrainzApiUrl').value,
                MusicBrainzApiUrl: document.querySelector('#MusicBrainzApiUrl').value,
                IsMusicBrainzEnabled: document.querySelector('#IsMusicBrainzEnabled').checked,
                IsAlternativeModeEnabled: document.querySelector('#IsAlternativeModeEnabled').checked,
                IsImmediateFavoriteSyncEnabled: document.querySelector('#IsImmediateFavoriteSyncEnabled').checked,
                IsAllPlaylistsSyncEnabled: document.querySelector('#IsAllPlaylistsSyncEnabled').checked,
                BackupPath: document.querySelector('#BackupPath').value,
                LibraryConfigs: getLibraryConfigsInputs(),
            }
        }

        function getLibraryConfigsInputs() {
            const checkboxes = document.querySelectorAll('[name^=library_]');
            return [...checkboxes].map(box => {
                return {
                    Id: box.id,
                    IsAllowed: box.checked,
                };
            });
        }

        function saveConfig(newConfig) {
            ApiClient.updatePluginConfiguration(ListenBrainzConfig.PluginUniqueId, newConfig)
                .then((result) => {
                    Dashboard.processPluginConfigurationUpdateResult(result);
                })
                .catch((reason) => {
                    console.log("ListenBrainz plugin: Failed to save config: " + reason);
                    Dashboard.alert("Failed to save plugin config");
                });
        }

        function loadConfig(userId) {
            ApiClient.getPluginConfiguration(ListenBrainzConfig.PluginUniqueId)
                .then((config) => {
                    fillGeneralConfig(config);
                    let userConfig = getUserConfig(config, userId);
                    fillUserConfig(userConfig);
                })
                .catch((reason) => {
                    console.log("ListenBrainz plugin: Failed to load plugin config: " + reason);
                    Dashboard.alert("Failed to load plugin config");
                });
        }

        function getApiToken() {
            let inputValue = document.querySelector('#ListenBrainzApiToken').value;
            return inputValue.trim();
        }

        async function tryGetListenBrainzUserName(apiToken) {
            const resp = await ApiClient.ValidateListenBrainzToken(apiToken);
            return resp.UserName;
        }

        async function buildAllowedLibrariesList(libraryConfigs) {
            const container = document.getElementById('LibrariesList');
            container.innerHTML = "";

            const allLibraries = await ApiClient.GetAllLibraries();

            function isAllowed(libraryId) {
                const config = libraryConfigs.find(lc => lc.Id === libraryId);
                if (config) return config.IsAllowed;

                const library = allLibraries.find(lib => lib.Id === libraryId);
                if (library) return library.LibraryType === 'music';
            }

            allLibraries.forEach((library) => {
                let label = document.createElement('label');
                label.classList.add('inputLabel', 'inputLabelUnfocused');
                label.htmlFor = getUniqueName(library);
                label.onclick = _ => {
                    let checkbox = document.getElementById(library.Id);
                    checkbox.checked = !checkbox.checked;
                };

                let input = document.createElement('input');
                input.setAttribute('is', 'emby-checkbox');
                input.type = 'checkbox';
                input.id = library.Id;
                input.name = getUniqueName(library);
                input.checked = isAllowed(library.Id) ?? false;

                let span = document.createElement('span');
                span.innerText = library.Name;

                label.appendChild(input);
                label.appendChild(span);
                container.appendChild(label);
            })
        }

        function getUniqueName(library) {
            // String template refuses to work
            return 'library_' + library.Id + '_IsAllowed';
        }

        ApiClient.ValidateListenBrainzToken = function (apiToken) {
            let url = this.getUrl('ListenBrainzPlugin/ValidateToken');
            return this.ajax({
                type: "POST",
                url: url,
                data: JSON.stringify(apiToken),
                contentType: "application/json",
                dataType: "json",
            });
        }

        ApiClient.GetAllLibraries = function () {
            let url = this.getUrl('ListenBrainzPlugin/internal/libraries');
            return this.ajax({
                type: "GET",
                url: url,
                dataType: "json",
            });
        }

        ApiClient.GetMusicLibraries = function () {
            let url = this.getUrl('ListenBrainzPlugin/internal/musicLibraries');
            return this.ajax({
                type: "GET",
                url: url,
                dataType: "json",
            });
        }
    </script>
</div>
</body>
</html>
